<?xml version="1.0" encoding="UTF-8"?>
<ui:composition xmlns:ace="http://www.icefaces.org/icefaces/components" xmlns:aui="http://liferay.com/faces/aui"
	xmlns:c="http://java.sun.com/jsp/jstl/core" xmlns:f="http://java.sun.com/jsf/core"
	xmlns:h="http://java.sun.com/jsf/html" xmlns:ui="http://java.sun.com/jsf/facelets">

	<h:outputScript library="chat" name="main.js" />
	<h:outputStylesheet library="chat" name="main.css" />

	<h:form id="f1">
		<c:set value="#{chatModelBean.myChatSessions}" var="myChatSessions" />
		<h:panelGroup styleClass="portlet-chat">
			<ace:dialog header="#{i18n.replace('online-friends-x', chatModelBean.dataModel.rowCount)}" widgetVar="onlineFriends">
				<ace:dataTable paginator="true" rows="#{chatModelBean.dataModel.rowsPerPage}" value="#{chatModelBean.dataModel}"
					var="user">
					<ace:column>
						<h:commandLink actionListener="#{chatBackingBean.chatWithUser(user)}" onclick="onlineFriends.hide()"
							value="#{user.fullName}" />
					</ace:column>
				</ace:dataTable>
			</ace:dialog>
			<ace:dialog id="currentChatSession" header="#{i18n['chat']}" styleClass="chat-panel" widgetVar="currentChatSession">
				<h:panelGroup layout="block" styleClass="panel-window">
					<h:graphicImage styleClass="panel-icon"
						value="#{liferay.portraitURL[chatModelBean.currentChatSession.friendUserId]}" />
					<h:panelGroup layout="block" styleClass="panel-title">
						<h:outputText value="#{chatModelBean.currentChatSession.friendFullName}" />
					</h:panelGroup>
					<h:panelGroup layout="block" styleClass="panel-profile" />
					<h:panelGroup id="panelOutput" layout="block" styleClass="panel-output">
						<ui:repeat value="#{chatModelBean.currentChatSession.chatMessages}" var="chatMessage">
							<p class="blurb #{chatMessage.getDirection(liferay.user.userId)}">
								<h:outputText styleClass="name" value="#{chatMessage.user.fullName}" />
								<h:outputText styleClass="date" value="#{chatMessage.date}">
									<f:convertDateTime pattern="hh:mm" />
								</h:outputText>
								<h:outputText styleClass="text" value="#{chatMessage.text}" />
							</p>
						</ui:repeat>
						<h:inputText id="messageText" style="width: 96%;" valueChangeListener="#{chatBackingBean.messageTextValueChanged}"
							value="#{chatBackingBean.messageText}" />
						<script type="text/javascript">
							iceFacesChat
									.scrollToBottom('#{liferayFacesContext.matchComponentInViewRoot("panelOutput").clientId}');
						</script>
						<script type="text/javascript">
							iceFacesChat
									.setFocus('#{liferayFacesContext.matchComponentInViewRoot("messageText").clientId}');
						</script>
					</h:panelGroup>
				</h:panelGroup>
			</ace:dialog>
			<h:panelGroup id="chatBar" layout="block" styleClass="chat-bar">
				<h:panelGroup layout="block" styleClass="chat-tabs-container">
					<aui:list styleClass="chat-tabs">
						<aui:list-item styleClass="buddy-list">
							<h:panelGroup layout="block" styleClass="panel-trigger aui-helper-unselectable">
								<h:commandLink onclick="onlineFriends.show()" styleClass="trigger-name"
									value="#{i18n.replace('online-friends-x', chatModelBean.dataModel.rowCount)}" />
							</h:panelGroup>
						</aui:list-item>
						<ui:repeat value="#{myChatSessions}" var="chatSession">
							<aui:list-item styleClass="user user_#{chatSession.friendUserId}">
								<h:panelGroup styleClass="panel-trigger aui-helper-unselectable">
									<h:commandLink value="#{chatSession.friendFullName}">
										<ace:ajax onComplete="currentChatSession.show()" />
										<f:setPropertyActionListener value="#{chatSession}" target="#{chatModelBean.currentChatSession}" />
									</h:commandLink>
								</h:panelGroup>
							</aui:list-item>
						</ui:repeat>
					</aui:list>
				</h:panelGroup>
			</h:panelGroup>
		</h:panelGroup>
	</h:form>

</ui:composition>
